#!/bin/bash

# --------------------------------------------
# Advanced Forensic Toolkit with ClamAV Setup
# --------------------------------------------

# Timestamped output directory
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
OUTPUT_DIR="$HOME/forensics_$TIMESTAMP"
mkdir -p "$OUTPUT_DIR"
LINPEAS_OUT="$OUTPUT_DIR/linpeas_output.txt"
SUSPICIOUS_OUT="$OUTPUT_DIR/suspicious_findings.txt"

# ----------------------------
# TOOLKIT DEPENDENCY CHECKERS
# ----------------------------

function check_and_install() {
    local pkg=$1
    if ! dpkg -s "$pkg" >/dev/null 2>&1; then
        echo "[*] Installing $pkg..."
        sudo apt update
        sudo apt install -y "$pkg"
    else
        echo "[+] $pkg is already installed."
    fi
}

function install_clamav() {
    echo "[*] Checking ClamAV..."
    check_and_install "clamav"
    check_and_install "clamav-daemon"

    echo "[*] Updating virus definitions..."
    sudo systemctl stop clamav-freshclam 2>/dev/null
    sudo freshclam
    echo "[+] ClamAV setup complete."
}

function remind_splunk_setup() {
    echo "------------------------------------------------"
    echo "🔔 Splunk Setup Reminder:"
    echo "To use Splunk integration, please install it manually:"
    echo "  https://www.splunk.com/en_us/download/splunk-enterprise.html"
    echo "Then configure your HEC token in the script."
    echo "------------------------------------------------"
}

# Run initial setup
echo "🛠️  Checking Toolkit Dependencies..."
install_clamav
remind_splunk_setup

# --------------------------------------------
# TOOLKIT FUNCTIONS
# --------------------------------------------

function run_linpeas() {
    echo "[+] Running LinPEAS..."
    curl -s https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/linPEAS/linpeas.sh | bash | tee "$LINPEAS_OUT"
    echo "[+] Extracting suspicious indicators..."
    grep -iE "suspicious|backdoor|bash -i|\.tmp|\.sh|\.py|nc |/dev/tcp|wget|curl|reverse shell|startup|hidden" "$LINPEAS_OUT" > "$SUSPICIOUS_OUT"
}

function check_network() {
    echo "[+] Collecting network info..."
    {
        echo "---- Active Connections ----"
        ss -tunap
        echo ""
        echo "---- Network Interfaces ----"
        ip a
        echo ""
        echo "---- Routing Table ----"
        ip route
    } > "$OUTPUT_DIR/network_analysis.txt"
}

function check_cron() {
    echo "[+] Checking cron jobs..."
    {
        echo "---- User Crontab ----"
        crontab -l 2>/dev/null
        echo ""
        echo "---- System Cron Files ----"
        find /etc/cron* -type f -exec ls -lt {} \; 2>/dev/null | head -n 20
    } > "$OUTPUT_DIR/cron_changes.txt"
}

function user_forensics() {
    echo "[+] Investigating user accounts..."
    {
        echo "---- Recently Added Users ----"
        tail -n 5 /etc/passwd
        echo ""
        echo "---- /etc/shadow Entries ----"
        sudo cat /etc/shadow 2>/dev/null || echo "Permission denied (run as root)"
    } > "$OUTPUT_DIR/user_forensics.txt"
}

function monitor_tmp() {
    echo "[+] Checking /tmp for new files..."
    find /tmp -type f -newermt "-1 day" -exec ls -lh {} \; 2>/dev/null > "$OUTPUT_DIR/tmp_new_files.txt"
    find /tmp -type f 2>/dev/null | while read file; do
        sha256sum "$file"
    done > "$OUTPUT_DIR/tmp_hashes.txt"
}

function run_clamav_scan() {
    read -p "Enter directory to scan (default: /tmp): " SCAN_DIR
    SCAN_DIR="${SCAN_DIR:-/tmp}"
    OUTPUT_FILE="$OUTPUT_DIR/clamav_scan.txt"

    echo "[+] Running ClamAV scan on: $SCAN_DIR"
    echo "Scanning directory: $SCAN_DIR" > "$OUTPUT_FILE"
    clamscan -r "$SCAN_DIR" >> "$OUTPUT_FILE"
    echo "[+] ClamAV scan complete. Results saved to $OUTPUT_FILE"
}

function summary_report() {
    echo "[+] Creating summary report..."
    {
        echo "=============================="
        echo "   ADVANCED FORENSIC REPORT   "
        echo "=============================="
        echo "Scan Time: $(date)"
        echo "Hostname : $(hostname)"
        echo "User     : $(whoami)"
        echo ""
        echo "--- Suspicious LinPEAS Output ---"
        cat "$SUSPICIOUS_OUT" 2>/dev/null
        echo ""
        echo "--- Network Info ---"
        cat "$OUTPUT_DIR/network_analysis.txt" 2>/dev/null
        echo ""
        echo "--- Cron Activity ---"
        cat "$OUTPUT_DIR/cron_changes.txt" 2>/dev/null
        echo ""
        echo "--- User Summary ---"
        cat "$OUTPUT_DIR/user_forensics.txt" 2>/dev/null
        echo ""
        echo "--- /tmp File Changes ---"
        cat "$OUTPUT_DIR/tmp_new_files.txt" 2>/dev/null
        echo ""
        echo "--- ClamAV Results ---"
        cat "$OUTPUT_DIR/clamav_scan.txt" 2>/dev/null
    } > "$OUTPUT_DIR/summary_report.txt"
    echo "[+] Summary report saved to $OUTPUT_DIR/summary_report.txt"
}

function run_all() {
    run_linpeas
    check_network
    check_cron
    user_forensics
    monitor_tmp
    run_clamav_scan
    summary_report
}

# --------------------------------------------
# INTERACTIVE MENU
# --------------------------------------------

while true; do
    clear
    echo "=============================="
    echo "  Linux Forensic Toolkit Menu"
    echo "=============================="
    echo "1) Run LinPEAS & Detect Suspicious Activity"
    echo "2) Network Analysis (IPs, Interfaces)"
    echo "3) Check Cron Jobs"
    echo "4) User & Password Forensics"
    echo "5) Monitor /tmp for New Files"
    echo "6) Run ClamAV Malware Scan"
    echo "7) Generate Summary Report"
    echo "8) Run ALL"
    echo "0) Exit"
    echo "------------------------------"
    read -p "Choose an option: " opt

    case $opt in
        1) run_linpeas ;;
        2) check_network ;;
        3) check_cron ;;
        4) user_forensics ;;
        5) monitor_tmp ;;
        6) run_clamav_scan ;;
        7) summary_report ;;
        8) run_all ;;
        0) echo "Exiting..." ; break ;;
        *) echo "Invalid option." ; sleep 1 ;;
    esac

    read -p "Press Enter to return to menu..."
done
