#!/bin/bash

# ===========================================
# LinPEAS Malware Toolkit
# Version: 2.0.0
# Description: Automated toolkit for network analysis,
# cron job monitoring, /tmp directory monitoring,
# user forensics, ClamAV scanning, and summary reporting.
# ===========================================

# Global Variables
LOG_DIR="/var/log/AutoThreatScan"
REPORT_FILE="$LOG_DIR/summary_report.txt"
sudo mkdir -p $LOG_DIR
sudo chmod 755 $LOG_DIR

# =============================
# Network Analysis
# =============================
function check_network() {
    echo "[+] Collecting network info..."
    sudo ip addr show | sudo tee $LOG_DIR/network_logs.log
    sudo netstat -anp | sudo tee -a $LOG_DIR/network_logs.log
    sudo ss -tuln | sudo tee -a $LOG_DIR/network_logs.log
    echo "[+] Network info collected and saved to $LOG_DIR/network_logs.log"
}

# =============================
# Cron Job Monitoring
# =============================
function check_cron() {
    echo "[+] Checking cron jobs ..."
    echo "---- User Crontab ----" | sudo tee $LOG_DIR/cron_changes.log
    crontab -l 2>/dev/null | sudo tee -a $LOG_DIR/cron_changes.log
    echo "---- System Cron Files ----" | sudo tee -a $LOG_DIR/cron_changes.log
    sudo ls -lt /etc/cron* | sudo tee -a $LOG_DIR/cron_changes.log
}

# =============================
# Monitor /tmp Directory
# =============================
function monitor_tmp() {
    echo "[+] Checking /tmp for new files..."
    timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "=== /tmp Directory Scan - $timestamp ===" | sudo tee $LOG_DIR/tmp_new_files.txt
    sudo find /tmp -type f -mtime -1 -exec ls -lh {} \; 2>/dev/null | sudo tee -a $LOG_DIR/tmp_new_files.txt
    echo "=== File Hashes ===" | sudo tee $LOG_DIR/tmp_hashes.txt
    sudo find /tmp -type f -mtime -1 2>/dev/null | while read file; do
        sha256sum "$file"
    done | sudo tee -a $LOG_DIR/tmp_hashes.txt
}

# =============================
# User & Password Forensics
# =============================
function user_forensics() {
    echo "[+] Investigating user accounts..."
    tail -n 5 /etc/passwd | sudo tee $LOG_DIR/user_monitor.log
    sudo cat /etc/shadow 2>/dev/null | sudo tee -a $LOG_DIR/user_monitor.log
}

# =============================
# ClamAV Scan
# =============================
function run_clamav_scan() {
    echo "[+] Running ClamAV Scan..."
    read -p "Enter the directory to scan (default: /home/kali): " SCAN_DIR
    if [[ -z "$SCAN_DIR" ]]; then
        SCAN_DIR="/home/kali"
    fi
    sudo clamscan -r "$SCAN_DIR" | sudo tee $LOG_DIR/clamav_scan.txt
    echo "[+] ClamAV scan complete. Log saved to $LOG_DIR/clamav_scan.txt"
}

# =============================
# Generate Summary Report
# =============================
function summary_report() {
    echo "[+] Generating Summary Report..."
    sudo touch $REPORT_FILE
    sudo chmod 755 $REPORT_FILE
    echo "===== AutoThreatScan Summary Report =====" | sudo tee $REPORT_FILE
    echo "Generated on: $(date)" | sudo tee -a $REPORT_FILE
    echo "=========================================" | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE

    echo "=== Network Analysis ===" | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/network_logs.log | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE

    echo "=== Cron Job Monitoring ===" | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/cron_changes.log | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE

    echo "=== /tmp Directory Monitoring ===" | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/tmp_new_files.txt | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/tmp_hashes.txt | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE

    echo "=== User & Password Forensics ===" | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/user_monitor.log | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE

    echo "=== ClamAV Scan Results ===" | sudo tee -a $REPORT_FILE
    sudo cat $LOG_DIR/clamav_scan.txt | sudo tee -a $REPORT_FILE
    echo "" | sudo tee -a $REPORT_FILE
}

# =============================
# Main Menu
# =============================
function main_menu() {
    while true; do
        clear
        echo "==== LinPEAS Malware Toolkit ===="
        echo "1) Network Analysis"
        echo "2) Cron Job Monitoring"
        echo "3) Monitor /tmp Directory"
        echo "4) User & Password Forensics"
        echo "5) ClamAV Malware Scan"
        echo "6) Generate Summary Report"
        echo "7) Exit"
        read -p "Select an option: " choice

        case $choice in
            1) check_network ;;
            2) check_cron ;;
            3) monitor_tmp ;;
            4) user_forensics ;;
            5) run_clamav_scan ;;
            6) summary_report ;;
            7) exit 0 ;;
            *) echo "Invalid option. Try again." ;;
        esac

        read -p "Press Enter to return to menu..."
    done
}

# Run the main menu
